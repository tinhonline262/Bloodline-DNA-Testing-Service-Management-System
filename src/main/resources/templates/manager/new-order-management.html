<!DOCTYPE html>
<html th:replace="~{layouts/manager-layout :: layout(~{::#content}, ~{::#page-scripts}, 'New Orders Management', null, null)}"
      xmlns:th="http://www.thymeleaf.org">

<div id="content">
  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex align-items-center justify-content-center mb-2">
            <div class="avatar bg-primary-transparent rounded-circle me-3">
              <i class="ri-file-list-3-line fs-16"></i>
            </div>
            <div>
              <h6 class="card-title text-muted mb-1">New Orders</h6>
              <h4 class="mb-0 text-primary" th:text="${newOrdersCount}">0</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex align-items-center justify-content-center mb-2">
            <div class="avatar bg-info-transparent rounded-circle me-3">
              <i class="ri-user-star-line fs-16"></i>
            </div>
            <div>
              <h6 class="card-title text-muted mb-1">Available Staff</h6>
              <h4 class="mb-0 text-info" th:text="${availableStaffCount}">0</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex align-items-center justify-content-center mb-2">
            <div class="avatar bg-success-transparent rounded-circle me-3">
              <i class="ri-checkbox-circle-line fs-16"></i>
            </div>
            <div>
              <h6 class="card-title text-muted mb-1">Assigned Today</h6>
              <h4 class="mb-0 text-success" th:text="${assignedTodayCount}">0</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex align-items-center justify-content-center mb-2">
            <div class="avatar bg-warning-transparent rounded-circle me-3">
              <i class="ri-time-line fs-16"></i>
            </div>
            <div>
              <h6 class="card-title text-muted mb-1">Pending Assignment</h6>
              <h4 class="mb-0 text-warning" th:text="${pendingAssignmentCount}">0</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Orders Table -->
  <div class="row">
    <div class="col-12">
      <div class="card custom-card">
        <div class="card-header">
          <div class="card-title">
            <i class="ri-notification-badge-line me-2"></i>New Orders Assignment
          </div>
          <div class="ms-auto">
            <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshNewOrders()">
              <i class="ri-refresh-line me-1"></i> Refresh
            </button>
            <button class="btn btn-sm btn-primary" onclick="loadAvailableStaff()">
              <i class="ri-user-add-line me-1"></i> Reload Staff
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Search and Filter Bar -->
          <div class="row mb-4">
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Search by Order ID, Customer name..."
                       id="searchNewOrders">
                <button class="btn btn-outline-secondary" type="button">
                  <i class="ri-search-line"></i>
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="dateFilter">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
            </div>
          </div>

          <!-- Orders Table -->
          <div class="table-responsive">
            <table class="table text-nowrap table-bordered table-hover align-middle" id="newOrdersTable">
              <thead class="table-light">
              <tr>
                <th scope="col">Order Details</th>
                <th scope="col">Customer</th>
                <th scope="col">Service</th>
                <th scope="col">Order Date</th>
                <th scope="col">Amount</th>
                <th scope="col">Assignment</th>
                <th scope="col">Actions</th>
              </tr>
              </thead>
              <tbody id="newOrdersTableBody">
              <!-- Thymeleaf-rendered orders -->
              <tr th:if="${#lists.isEmpty(newOrders)}">
                <td colspan="7" class="text-center py-5">
                  <div class="display-1 text-muted mb-3">
                    <i class="ri-inbox-line"></i>
                  </div>
                  <h5 class="text-muted">No New Orders Found</h5>
                  <p class="text-muted mb-0">All orders have been assigned or there are no new orders at this time.</p>
                </td>
              </tr>
              <tr th:each="order : ${newOrders}" th:unless="${#lists.isEmpty(newOrders)}">
                <td>
                  <div class="d-flex align-items-center">
                    <div class="order-icon me-3">
                      <i class="ri-file-list-3-line text-primary fs-4"></i>
                    </div>
                    <div>
                      <strong th:text="${order.id}">Order ID</strong><br>
                      <small class="text-muted"
                             th:text="${'Created: ' + #temporals.format(order.createdAt, 'MMM dd, yyyy HH:mm')}">Order Date</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div>
                    <strong th:text="${order.customerName}">Customer Name</strong><br>
                    <small class="text-muted" th:text="${order.email}">customer@email.com</small><br>
                    <small class="text-muted" th:text="${order.phoneNumber}">+1 (555) 123-4567</small>
                  </div>
                </td>
                <td>
                  <div>
                    <span class="fw-semibold" th:text="${order.serviceName}">Service Name</span><br>
                    <small class="text-muted"
                           th:text="${'Appointment: ' + #temporals.format(order.appointmentDate, 'MMM dd, yyyy')}">Appointment Date</small>
                  </div>
                </td>
                <td>
                  <div>
                    <span th:text="${#temporals.format(order.createdAt, 'MMM dd, yyyy')}">Order Date</span><br>
                    <small class="text-muted" th:text="${#temporals.format(order.createdAt, 'HH:mm')}">Time</small>
                  </div>
                </td>
                <td><strong th:text="${'$' + order.totalAmount}">Amount</strong></td>
                <td>
                  <div class="assignment-status unassigned">
                    <i class="ri-time-line me-1"></i>
                    Unassigned
                  </div>
                  <button class="btn btn-sm btn-primary"
                          th:attr="data-order-id=${order.id}, data-customer-name=${order.customerName}, data-service-name=${order.serviceName}, data-appointment-date=${order.appointmentDate}"
                          onclick="openAssignmentModal(this)">
                    <i class="ri-user-add-line me-1"></i>Assign Staff
                  </button>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info action-btn" th:attr="data-order-id=${order.id},
                 data-customer-name=${order.customerName},
                 data-customer-email=${order.email},
                 data-customer-phone=${order.phoneNumber},
                 data-service-name=${order.serviceName},
                 data-total-amount=${order.totalAmount},
                 data-order-date=${#temporals.format(order.createdAt, 'MMM dd, yyyy')},
                 data-appointment-date=${order.appointmentDate},
                 data-order-status=${order.orderStatus}
                "
                            onclick="viewOrderDetails(this)" data-bs-toggle="tooltip" title="View Details">
                      <i class="ri-eye-line"></i>
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Staff Assignment Modal -->
  <div class="modal fade" id="staffAssignmentModal" tabindex="-1" aria-labelledby="staffAssignmentModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staffAssignmentModalLabel">
            <i class="ri-user-settings-line me-2"></i>Assign Staff to Order
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Assignment Form -->
          <form id="staffAssignmentForm" th:action="@{/manager/assign-staff}" method="post">
            <!-- Order Information -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="ri-file-info-line me-2"></i>Order Information
                </h6>
              </div>
              <div class="card-body" id="orderInfoSection">
                <div class="row">
                  <div class="col-md-6">
                    <strong>Order ID:</strong> <span id="modalOrderId">-</span><br>
                    <strong>Customer:</strong> <span id="modalCustomerName">-</span><br>
                    <strong>Service:</strong> <span id="modalServiceName">-</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Appointment Date:</strong> <span id="modalAppointmentDate">-</span><br>
                    <strong>Status:</strong> <span class="badge bg-warning">New</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Staff Assignment Sections -->
            <div class="row">
              <!-- Sample Collection Staff -->
              <div class="col-md-6">
                <div class="card mb-4">
                  <div class="card-header bg-primary-light">
                    <h6 class="mb-0 text-primary">
                      <i class="ri-test-tube-line me-2"></i>Sample Collection Staff
                      <span class="text-danger">*</span>
                    </h6>
                    <small class="text-muted">Select staff to collect DNA samples from customers</small>
                  </div>
                  <div class="card-body">
                    <div id="collectionStaffContainer">
                      <!-- Thymeleaf-rendered staff cards for collection -->
                      <div th:if="${#lists.isEmpty(availableStaff)}" class="alert alert-warning">
                        <i class="ri-alert-line me-2"></i>No staff available for collection at this time.
                      </div>
                      <div th:each="staff : ${availableStaff}" th:unless="${#lists.isEmpty(availableStaff)}"
                           class="mb-3">
                        <div class="card staff-card collection-staff" th:attr="data-staff-id=${staff.id}" onclick="selectCollectionStaff(this)">
                          <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                              <div class="avatar avatar-md rounded-circle me-3">
                                <img th:src="${staff.profileImageUrl}" th:alt="${staff.fullName}"
                                     class="avatar-img rounded-circle"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="avatar-initials bg-primary text-white rounded-circle d-none"
                                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                  <span
                                          th:text="${#strings.substring(staff.fullName, 0, 1) + #strings.substring(#strings.substringAfter(staff.fullName, ' '), 0, 1)}">AA</span>
                                </div>
                              </div>
                              <div class="flex-grow-1">
                                <h6 class="mb-1" th:text="${staff.fullName}">Staff Name</h6>
                                <small class="text-muted" th:text="${staff.email}">Email</small><br>
                                <small class="text-muted" th:text="${staff.phoneNumber}">Phone</small>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="collectStaffId" th:value="${staff.id}" required>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Analysis Staff -->
              <div class="col-md-6">
                <div class="card mb-4">
                  <div class="card-header bg-success-light">
                    <h6 class="mb-0 text-success">
                      <i class="ri-file-chart-line me-2"></i>Analysis Staff
                      <span class="text-danger">*</span>
                    </h6>
                    <small class="text-muted">Select staff to analyze results and prepare reports</small>
                  </div>
                  <div class="card-body">
                    <div id="analysisStaffContainer">
                      <!-- Thymeleaf-rendered staff cards for analysis -->
                      <div th:if="${#lists.isEmpty(availableStaff)}" class="alert alert-warning">
                        <i class="ri-alert-line me-2"></i>No staff available for analysis at this time.
                      </div>
                      <div th:each="staff : ${availableStaff}" th:unless="${#lists.isEmpty(availableStaff)}"
                           class="mb-3">
                        <div class="card staff-card analysis-staff" th:attr="data-staff-id=${staff.id}" onclick="selectAnalysisStaff(this)">
                          <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                              <div class="avatar avatar-md rounded-circle me-3">
                                <img th:src="${staff.profileImageUrl}" th:alt="${staff.fullName}"
                                     class="avatar-img rounded-circle"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="avatar-initials bg-success text-white rounded-circle d-none"
                                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                  <span
                                          th:text="${#strings.substring(staff.fullName, 0, 1) + #strings.substring(#strings.substringAfter(staff.fullName, ' '), 0, 1)}">AA</span>
                                </div>
                              </div>
                              <div class="flex-grow-1">
                                <h6 class="mb-1" th:text="${staff.fullName}">Staff Name</h6>
                                <small class="text-muted" th:text="${staff.email}">Email</small><br>
                                <small class="text-muted" th:text="${staff.phoneNumber}">Phone</small>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="analysisStaffId" th:value="${staff.id}" required>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Assignment Summary -->
            <div class="card mb-4 d-none" id="assignmentSummary">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="ri-clipboard-line me-2"></i>Assignment Summary
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                      <i class="ri-test-tube-line text-primary me-2"></i>
                      <strong>Collection Staff:</strong>
                      <span id="selectedCollectionStaff" class="ms-2 text-muted">Not selected</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                      <i class="ri-file-chart-line text-success me-2"></i>
                      <strong>Analysis Staff:</strong>
                      <span id="selectedAnalysisStaff" class="ms-2 text-muted">Not selected</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Assignment Notes -->
            <div class="mb-3">
              <label for="assignmentNotes" class="form-label fw-semibold">Assignment Notes (Optional)</label>
              <textarea class="form-control" id="assignmentNotes" name="notes" rows="3"
                        placeholder="Add any special instructions or notes for the assigned staff..."></textarea>
            </div>

            <!-- Hidden Form Data -->
            <input type="hidden" id="selectedOrderId" name="orderId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="ri-close-line me-1"></i>Cancel
          </button>
          <button type="submit" form="staffAssignmentForm" class="btn btn-primary" id="confirmAssignmentBtn" disabled>
            <i class="ri-user-add-line me-1"></i>Assign Staff
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orderDetailsModalLabel">
            <i class="ri-file-list-3-line me-2"></i>Order Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="orderDetailsContent">
          <!-- Order details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="ri-close-line me-1"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block id="page-scripts">
  <th:block th:replace="~{fragments/common/scripts :: scripts}"></th:block>
  <script>
    let selectedCollectionStaffId = null;
    let selectedAnalysisStaffId = null;

    // Collection staff selection functionality
    function selectCollectionStaff(staffCard) {
      const staffId = staffCard.getAttribute('data-staff-id');
      const staffName = staffCard.querySelector('h6').textContent;

      // Remove previous collection selection
      document.querySelectorAll('.collection-staff').forEach(card => {
        card.classList.remove('selected');
      });

      // Add selection to clicked card
      staffCard.classList.add('selected');

      // Select the radio button
      const radio = staffCard.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        selectedCollectionStaffId = staffId;
      }

      // Update summary
      document.getElementById('selectedCollectionStaff').textContent = staffName;

      // Disable this staff in analysis section
      updateStaffAvailability();

      // Check if both staff are selected
      checkAssignmentCompletion();
    }

    // Analysis staff selection functionality
    function selectAnalysisStaff(staffCard) {
      const staffId = staffCard.getAttribute('data-staff-id');
      const staffName = staffCard.querySelector('h6').textContent;

      // Remove previous analysis selection
      document.querySelectorAll('.analysis-staff').forEach(card => {
        card.classList.remove('selected');
      });

      // Add selection to clicked card
      staffCard.classList.add('selected');

      // Select the radio button
      const radio = staffCard.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        selectedAnalysisStaffId = staffId;
      }

      // Update summary
      document.getElementById('selectedAnalysisStaff').textContent = staffName;

      // Disable this staff in collection section
      updateStaffAvailability();

      // Check if both staff are selected
      checkAssignmentCompletion();
    }

    // Update staff availability based on selections
    function updateStaffAvailability() {
      // Disable collection staff in analysis section
      document.querySelectorAll('.analysis-staff').forEach(card => {
        const staffId = card.getAttribute('data-staff-id');
        if (staffId === selectedCollectionStaffId) {
          card.classList.add('disabled');
          card.style.opacity = '0.5';
          card.style.pointerEvents = 'none';
          const radio = card.querySelector('input[type="radio"]');
          if (radio) {
            radio.disabled = true;
          }
        } else {
          card.classList.remove('disabled');
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
          const radio = card.querySelector('input[type="radio"]');
          if (radio) {
            radio.disabled = false;
          }
        }
      });

      // Disable analysis staff in collection section
      document.querySelectorAll('.collection-staff').forEach(card => {
        const staffId = card.getAttribute('data-staff-id');
        if (staffId === selectedAnalysisStaffId) {
          card.classList.add('disabled');
          card.style.opacity = '0.5';
          card.style.pointerEvents = 'none';
          const radio = card.querySelector('input[type="radio"]');
          if (radio) {
            radio.disabled = true;
          }
        } else {
          card.classList.remove('disabled');
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
          const radio = card.querySelector('input[type="radio"]');
          if (radio) {
            radio.disabled = false;
          }
        }
      });
    }

    // Check if both staff are selected and enable submit button
    function checkAssignmentCompletion() {
      const assignmentSummary = document.getElementById('assignmentSummary');
      const confirmBtn = document.getElementById('confirmAssignmentBtn');

      if (selectedCollectionStaffId && selectedAnalysisStaffId) {
        assignmentSummary.classList.remove('d-none');
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('btn-secondary');
        confirmBtn.classList.add('btn-primary');
      } else {
        assignmentSummary.classList.add('d-none');
        confirmBtn.disabled = true;
        confirmBtn.classList.remove('btn-primary');
        confirmBtn.classList.add('btn-secondary');
      }
    }

    // Open assignment modal
    function openAssignmentModal(button) {
      const orderId = button.getAttribute('data-order-id');
      const customerName = button.getAttribute('data-customer-name');
      const serviceName = button.getAttribute('data-service-name');
      const appointmentDate = button.getAttribute('data-appointment-date');

      // Populate order information
      document.getElementById('modalOrderId').textContent = orderId;
      document.getElementById('modalCustomerName').textContent = customerName;
      document.getElementById('modalServiceName').textContent = serviceName;
      document.getElementById('modalAppointmentDate').textContent = appointmentDate;
      document.getElementById('selectedOrderId').value = orderId;

      // Reset form and selections
      resetForm();

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('staffAssignmentModal'));
      modal.show();
    }

    // Reset form to initial state
    function resetForm() {
      document.getElementById('staffAssignmentForm').reset();

      // Reset selections
      selectedCollectionStaffId = null;
      selectedAnalysisStaffId = null;

      // Remove all selections and enable all cards
      document.querySelectorAll('.staff-card').forEach(card => {
        card.classList.remove('selected', 'disabled');
        card.style.opacity = '1';
        card.style.pointerEvents = 'auto';
        const radio = card.querySelector('input[type="radio"]');
        if (radio) {
          radio.disabled = false;
          radio.checked = false;
        }
      });

      // Reset summary
      document.getElementById('selectedCollectionStaff').textContent = 'Not selected';
      document.getElementById('selectedAnalysisStaff').textContent = 'Not selected';
      document.getElementById('assignmentSummary').classList.add('d-none');

      // Disable submit button
      const confirmBtn = document.getElementById('confirmAssignmentBtn');
      confirmBtn.disabled = true;
      confirmBtn.classList.remove('btn-primary');
      confirmBtn.classList.add('btn-secondary');
    }

    // View order details
    function viewOrderDetails(button) {
      const orderId = button.getAttribute('data-order-id');
      const customerName = button.getAttribute('data-customer-name');
      const customerEmail = button.getAttribute('data-customer-email');
      const customerPhone = button.getAttribute('data-customer-phone');
      const serviceName = button.getAttribute('data-service-name');
      const totalAmount = button.getAttribute('data-total-amount');
      const orderDate = button.getAttribute('data-order-date');
      const appointmentDate = button.getAttribute('data-appointment-date');
      const modalContent = document.getElementById('orderDetailsContent');

      modalContent.innerHTML = `
        <div class="order-info-card">
            <h6><i class="ri-file-info-line me-2"></i>Order Information</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="info-row">
                        <span class="info-label">Order ID:</span>
                        <span class="info-value">${orderId}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Order Date:</span>
                        <span class="info-value">${orderDate}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Service:</span>
                        <span class="info-value">${serviceName}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-row">
                        <span class="info-label">Customer:</span>
                        <span class="info-value">${customerName}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value">${customerEmail}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone:</span>
                        <span class="info-value">${customerPhone}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Amount:</span>
                        <span class="info-value">${totalAmount}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h6 class="text-primary mb-3">Appointment Details</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="ri-calendar-line text-primary me-3 fs-18"></i>
                            <div>
                                <strong>Scheduled Date:</strong> ${appointmentDate}<br>
                                <small class="text-muted">Sample collection appointment</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      `;

      const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
      modal.show();
    }

    // Form submission with loading state
    document.getElementById('staffAssignmentForm').addEventListener('submit', function (e) {
      const submitBtn = document.getElementById('confirmAssignmentBtn');
      const originalText = submitBtn.innerHTML;

      // Show loading state
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Assigning...';
      submitBtn.disabled = true;

      // Re-enable after form submission (in case of validation errors)
      setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }, 3000);
    });

    // Refresh functions
    function refreshNewOrders() {
      window.location.reload();
    }

    function loadAvailableStaff() {
      window.location.reload();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Add CSS styles
      const style = document.createElement('style');
      style.textContent = `
        .staff-card {
          cursor: pointer;
          transition: all 0.2s ease;
          border: 2px solid transparent;
        }
        .staff-card:hover:not(.disabled) {
          border-color: #6c5ce7;
          transform: translateY(-2px);
        }
        .staff-card.selected {
          border-color: #6c5ce7;
          background-color: #f8f9fa;
        }
        .staff-card.disabled {
          cursor: not-allowed;
          opacity: 0.5 !important;
          pointer-events: none !important;
        }
        .collection-staff.selected {
          border-color: #007bff;
          background-color: #e3f2fd;
        }
        .analysis-staff.selected {
          border-color: #28a745;
          background-color: #e8f5e8;
        }
        .bg-primary-light {
          background-color: #e3f2fd !important;
        }
        .bg-success-light {
          background-color: #e8f5e8 !important;
        }
        .order-icon {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: #e3f2fd;
          color: #1976d2;
        }
        .assignment-status {
          display: inline-flex;
          align-items: center;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          margin-bottom: 8px;
        }
        .assignment-status.unassigned {
          background-color: #fff3e0;
          color: #f57c00;
        }
        .info-row {
          margin-bottom: 8px;
        }
        .info-label {
          font-weight: 600;
          color: #495057;
        }
        .info-value {
          color: #6c757d;
        }
      `;
      document.head.appendChild(style);

      console.log('New Orders management page loaded with dual staff assignment');
    });
  </script>

  <!-- Flash Messages -->
  <script th:if="${successMessage}">
    Swal.fire({
      icon: 'success',
      title: 'Success!',
      text: '[[${successMessage}]]',
      timer: 3000,
      showConfirmButton: false
    });
  </script>

  <script th:if="${errorMessage}">
    Swal.fire({
      icon: 'error',
      title: 'Error!',
      text: '[[${errorMessage}]]',
      timer: 3000,
      showConfirmButton: false
    });
  </script>
</th:block>

</html>