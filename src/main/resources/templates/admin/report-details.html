<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layouts/admin-layout :: layout(~{::#main-content}, ~{::#page-scripts}, ${pageTitle}, ${breadcrumbs}, ~{::#action-buttons})}">

<div id="main-content">
    <!-- Alert for errors -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}">Error message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Report Details Card -->
    <div class="card custom-card" th:if="${report}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="card-title">
                <h4 class="mb-0">Report Details</h4>
                <small class="text-muted">Report ID: <span class="fw-semibold text-primary"
                        th:text="'#' + ${report.reportId}">#12345</span></small>
            </div>
            <div>
                <span class="badge fs-12" th:classappend="${report.reportStatus.name() == 'GENERATED' ? 'bg-warning-transparent text-warning' :
                                  (report.reportStatus.name() == 'APPROVED' ? 'bg-success-transparent text-success' :
                                  (report.reportStatus.name() == 'REJECTED' ? 'bg-danger-transparent text-danger' :
                                  'bg-secondary-transparent text-secondary'))}"
                    th:text="${#strings.toLowerCase(report.reportStatus.name())}">Status</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Basic Information -->
                <div class="col-xl-6 col-lg-6 col-md-12">
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-header bg-transparent border-0">
                            <h6 class="mb-0"><i class="ri-file-info-line me-2"></i>Basic Information</h6>
                        </div>
                        <div class="card-body pt-0">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Report Name</label>
                                    <p class="mb-2" th:text="${report.reportName}">Report Name</p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-semibold">Report Type</label>
                                    <p class="mb-2">
                                        <span class="badge bg-info-transparent text-info"
                                            th:text="${report.reportType.description}">Report Type</span>
                                    </p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-semibold">Category</label>
                                    <p class="mb-2" th:text="${report.reportCategory}">Category</p>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Status</label>
                                    <p class="mb-2">
                                        <span class="badge fs-12" th:classappend="${report.reportStatus.name() == 'GENERATED' ? 'bg-warning-transparent text-warning' :
                                                          (report.reportStatus.name() == 'APPROVED' ? 'bg-success-transparent text-success' :
                                                          (report.reportStatus.name() == 'REJECTED' ? 'bg-danger-transparent text-danger' :
                                                          'bg-secondary-transparent text-secondary'))}"
                                            th:text="${#strings.toLowerCase(report.reportStatus.name())}">Status</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generated By Information -->
                <div class="col-xl-6 col-lg-6 col-md-12">
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-header bg-transparent border-0">
                            <h6 class="mb-0"><i class="ri-user-line me-2"></i>Generated By</h6>
                        </div>
                        <div class="card-body pt-0">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar avatar-lg me-3">
                                    <img th:if="${report.generatedByUserImageUrl != null and !#strings.isEmpty(report.generatedByUserImageUrl)}"
                                        th:src="@{${report.generatedByUserImageUrl}}" alt="Profile"
                                        class="avatar-img rounded-circle">
                                    <span
                                        th:unless="${report.generatedByUserImageUrl != null and !#strings.isEmpty(report.generatedByUserImageUrl)}"
                                        class="avatar-initials rounded-circle bg-primary text-white fs-18"
                                        th:text="${#strings.isEmpty(report.generatedByUserName) ? '-' : #strings.substring(report.generatedByUserName, 0, 1)}">U</span>
                                </div>
                                <div>
                                    <h6 class="mb-1" th:text="${report.generatedByUserName}">User Name</h6>
                                    <p class="text-muted mb-1" th:text="${report.generatedByUserEmail}">user@email.com
                                    </p>
                                    <span class="badge bg-primary-transparent text-primary"
                                        th:text="${report.generatedByUserRole}">Role</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Data -->
            <div class="card bg-light border-0 mb-4">
                <div class="card-header bg-transparent border-0">
                    <h6 class="mb-0"><i class="ri-file-text-line me-2"></i>Report Data</h6>
                </div>
                <div class="card-body pt-0">
                    <div class="border rounded p-3 bg-white">
                        <pre class="mb-0 text-wrap" style="white-space: pre-wrap; font-family: inherit;"
                            th:text="${report.reportData}">Report data content will be displayed here...</pre>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card bg-light border-0">
                <div class="card-header bg-transparent border-0">
                    <h6 class="mb-0"><i class="ri-settings-line me-2"></i>Actions</h6>
                </div>
                <div class="card-body pt-0">
                    <div class="btn-group me-2" role="group">
                        <button type="button" class="btn btn-success"
                            th:onclick="'updateReportStatus(' + ${report.reportId} + ', \'APPROVED\')'">
                            <i class="ri-check-line me-1"></i>Approve Report
                        </button>
                        <button type="button" class="btn btn-danger"
                            th:onclick="'updateReportStatus(' + ${report.reportId} + ', \'REJECTED\')'">
                            <i class="ri-close-line me-1"></i>Reject Report
                        </button>
                        <button type="button" class="btn btn-warning"
                            th:onclick="'updateReportStatus(' + ${report.reportId} + ', \'GENERATED\')'">
                            <i class="ri-refresh-line me-1"></i>Reset to Generated
                        </button>
                    </div>
                    <button type="button" class="btn btn-info"
                        th:onclick="'downloadReport(' + ${report.reportId} + ')'">
                        <i class="ri-download-line me-1"></i>Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- No Report Found -->
    <div class="card custom-card" th:unless="${report}">
        <div class="card-body text-center py-5">
            <div class="text-muted">
                <i class="ri-file-search-line fs-48 d-block mb-3"></i>
                <h5>Report Not Found</h5>
                <p>The requested report could not be found or may have been deleted.</p>
                <a href="/admin/reports" class="btn btn-primary">
                    <i class="ri-arrow-left-line me-1"></i>Back to Reports
                </a>
            </div>
        </div>
    </div>
</div>

<div id="action-buttons">
    <div class="d-flex gap-2">
        <a href="/admin/reports" class="btn btn-secondary">
            <i class="ri-arrow-left-line me-1"></i>Back to Reports
        </a>
        <button type="button" class="btn btn-primary" onclick="window.location.reload()">
            <i class="ri-refresh-line me-1"></i>Refresh
        </button>
        <div class="btn-group" th:if="${report}">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="ri-more-2-line me-1"></i>More Actions
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#"
                        th:onclick="'updateReportStatus(' + ${report.reportId} + ', \'APPROVED\')'">
                        <i class="ri-check-line me-2"></i>Approve Report</a></li>
                <li><a class="dropdown-item" href="#"
                        th:onclick="'updateReportStatus(' + ${report.reportId} + ', \'REJECTED\')'">
                        <i class="ri-close-line me-2"></i>Reject Report</a></li>
                <li><a class="dropdown-item" href="#"
                        th:onclick="'updateReportStatus(' + ${report.reportId} + ', \'GENERATED\')'">
                        <i class="ri-refresh-line me-2"></i>Reset to Generated</a></li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" th:onclick="'downloadReport(' + ${report.reportId} + ')'">
                        <i class="ri-download-line me-2"></i>Download Report</a></li>
                <li><a class="dropdown-item" href="#" onclick="printReport()">
                        <i class="ri-printer-line me-2"></i>Print Report</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="page-scripts">
    <script type="text/html" th:replace="~{fragments/common/scripts :: scripts}"></script>

    <script>
        function updateReportStatus(reportId, status) {
            if (confirm('Are you sure you want to update this report status to ' + status.toLowerCase() + '?')) {
                fetch('/admin/reports/' + reportId + '/update-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'status=' + encodeURIComponent(status) + '&notes=' + encodeURIComponent('Status updated by admin')
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            showAlert('success', data.message);
                            // Reload page after short delay
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showAlert('danger', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('danger', 'An error occurred while updating the report status.');
                    });
            }
        }

        function downloadReport(reportId) {
            // Implement download functionality
            showAlert('info', 'Download functionality will be implemented for report ID: ' + reportId);
        }

        function printReport() {
            // Hide action buttons and print
            const actionButtons = document.querySelectorAll('#action-buttons, .card .card-body .btn-group, .card .card-body .btn');
            actionButtons.forEach(el => el.style.display = 'none');

            window.print();

            // Restore action buttons after print
            setTimeout(() => {
                actionButtons.forEach(el => el.style.display = '');
            }, 1000);
        }

        function showAlert(type, message) {
            const alertContainer = document.querySelector('#main-content');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.insertBefore(alert, alertContainer.firstChild);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert && alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</div>

</html>