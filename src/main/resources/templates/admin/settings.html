<!DOCTYPE html>
<html th:replace="~{layouts/admin-layout :: layout(~{::#content}, ~{::script}, 'System Settings', ~{::breadcrumbs}, ~{::actionButtons})}"
    xmlns:th="http://www.thymeleaf.org" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light"
    data-menu-styles="light" loader="disable" data-vertical-style="overlay" class="mdl-js"
    data-toggled="icon-overlay-close">

<body>
    <!-- Breadcrumbs -->
    <div id="breadcrumbs">
        <li class="breadcrumb-item"><a th:href="@{/admin/settings}">System Settings</a></li>
        <li class="breadcrumb-item active">General</li>
    </div>

    <!-- Action Buttons -->
    <div id="actionButtons">
        <button class="btn btn-success me-2" onclick="saveAllSettings()">
            <i class="ri-save-line me-1"></i>Save All Settings
        </button>
        <button class="btn btn-outline-secondary" onclick="resetToDefaults()">
            <i class="ri-restart-line me-1"></i>Reset to Defaults
        </button>
    </div>

    <div id="content">
        <!-- Settings Navigation -->
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Settings Categories</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="#general" class="list-group-item list-group-item-action active" data-bs-toggle="pill">
                            <i class="ri-settings-3-line me-2"></i>General Settings
                        </a>
                        <a href="#email" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                            <i class="ri-mail-settings-line me-2"></i>Email Configuration
                        </a>
                        <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                            <i class="ri-shield-check-line me-2"></i>Security Settings
                        </a>
                        <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                            <i class="ri-notification-2-line me-2"></i>Notifications
                        </a>
                        <a href="#maintenance" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                            <i class="ri-tools-line me-2"></i>Maintenance
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="tab-content">
                    <!-- General Settings -->
                    <div class="tab-pane fade show active" id="general">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">General System Settings</h5>
                            </div>
                            <div class="card-body">
                                <form id="generalSettingsForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="systemName" class="form-label">System Name</label>
                                                <input type="text" class="form-control" id="systemName" 
                                                       th:value="${settings?.systemName ?: 'Bloodline DNA Testing Service'}" 
                                                       name="systemName">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="systemVersion" class="form-label">System Version</label>
                                                <input type="text" class="form-control" id="systemVersion" 
                                                       th:value="${settings?.systemVersion ?: '1.0.0'}" 
                                                       name="systemVersion" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="timezone" class="form-label">Default Timezone</label>
                                                <select class="form-select" id="timezone" name="timezone">
                                                    <option value="UTC">UTC</option>
                                                    <option value="America/New_York">Eastern Time (ET)</option>
                                                    <option value="America/Chicago">Central Time (CT)</option>
                                                    <option value="America/Denver">Mountain Time (MT)</option>
                                                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                                    <option value="Asia/Ho_Chi_Minh" selected>Vietnam Time (VN)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dateFormat" class="form-label">Date Format</label>
                                                <select class="form-select" id="dateFormat" name="dateFormat">
                                                    <option value="dd/MM/yyyy" selected>DD/MM/YYYY</option>
                                                    <option value="MM/dd/yyyy">MM/DD/YYYY</option>
                                                    <option value="yyyy-MM-dd">YYYY-MM-DD</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="currency" class="form-label">Default Currency</label>
                                                <select class="form-select" id="currency" name="currency">
                                                    <option value="USD">USD - US Dollar</option>
                                                    <option value="EUR">EUR - Euro</option>
                                                    <option value="VND" selected>VND - Vietnamese Dong</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="language" class="form-label">Default Language</label>
                                                <select class="form-select" id="language" name="language">
                                                    <option value="en">English</option>
                                                    <option value="vi" selected>Vietnamese</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="maintenanceMode" 
                                                   name="maintenanceMode">
                                            <label class="form-check-label" for="maintenanceMode">
                                                Maintenance Mode
                                            </label>
                                            <div class="form-text">When enabled, only administrators can access the system</div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="userRegistration" 
                                                   name="userRegistration" checked>
                                            <label class="form-check-label" for="userRegistration">
                                                Allow User Registration
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Email Configuration -->
                    <div class="tab-pane fade" id="email">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Email Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="emailSettingsForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpHost" class="form-label">SMTP Host</label>
                                                <input type="text" class="form-control" id="smtpHost" 
                                                       name="smtpHost" placeholder="smtp.gmail.com">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpPort" class="form-label">SMTP Port</label>
                                                <input type="number" class="form-control" id="smtpPort" 
                                                       name="smtpPort" value="587">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpUsername" class="form-label">SMTP Username</label>
                                                <input type="text" class="form-control" id="smtpUsername" 
                                                       name="smtpUsername">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpPassword" class="form-label">SMTP Password</label>
                                                <input type="password" class="form-control" id="smtpPassword" 
                                                       name="smtpPassword">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="fromEmail" class="form-label">From Email</label>
                                                <input type="email" class="form-control" id="fromEmail" 
                                                       name="fromEmail" placeholder="noreply@bloodlinedna.com">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="fromName" class="form-label">From Name</label>
                                                <input type="text" class="form-control" id="fromName" 
                                                       name="fromName" value="Bloodline DNA Testing">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableTLS" 
                                                   name="enableTLS" checked>
                                            <label class="form-check-label" for="enableTLS">
                                                Enable TLS
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-primary" onclick="testEmailConnection()">
                                            <i class="ri-mail-send-line me-1"></i>Test Email Connection
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="security">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Security Settings</h5>
                            </div>
                            <div class="card-body">
                                <form id="securitySettingsForm">
                                    <h6 class="mb-3">Password Policy</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="minPasswordLength" class="form-label">Minimum Password Length</label>
                                                <input type="number" class="form-control" id="minPasswordLength" 
                                                       name="minPasswordLength" value="8" min="6" max="20">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="passwordExpiry" class="form-label">Password Expiry (days)</label>
                                                <input type="number" class="form-control" id="passwordExpiry" 
                                                       name="passwordExpiry" value="90">
                                                <div class="form-text">0 = Never expires</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireUppercase" 
                                                   name="requireUppercase" checked>
                                            <label class="form-check-label" for="requireUppercase">
                                                Require uppercase letters
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireNumbers" 
                                                   name="requireNumbers" checked>
                                            <label class="form-check-label" for="requireNumbers">
                                                Require numbers
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireSpecialChars" 
                                                   name="requireSpecialChars">
                                            <label class="form-check-label" for="requireSpecialChars">
                                                Require special characters
                                            </label>
                                        </div>
                                    </div>

                                    <hr>

                                    <h6 class="mb-3">Session Management</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="sessionTimeout" class="form-label">Session Timeout (minutes)</label>
                                                <input type="number" class="form-control" id="sessionTimeout" 
                                                       name="sessionTimeout" value="30" min="5" max="480">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maxLoginAttempts" class="form-label">Max Login Attempts</label>
                                                <input type="number" class="form-control" id="maxLoginAttempts" 
                                                       name="maxLoginAttempts" value="5" min="3" max="10">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableTwoFactor" 
                                                   name="enableTwoFactor">
                                            <label class="form-check-label" for="enableTwoFactor">
                                                Enable Two-Factor Authentication
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="tab-pane fade" id="notifications">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Notification Settings</h5>
                            </div>
                            <div class="card-body">
                                <form id="notificationSettingsForm">
                                    <h6 class="mb-3">System Notifications</h6>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications" 
                                                   name="emailNotifications" checked>
                                            <label class="form-check-label" for="emailNotifications">
                                                Enable Email Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="smsNotifications" 
                                                   name="smsNotifications">
                                            <label class="form-check-label" for="smsNotifications">
                                                Enable SMS Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="pushNotifications" 
                                                   name="pushNotifications" checked>
                                            <label class="form-check-label" for="pushNotifications">
                                                Enable Push Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <hr>

                                    <h6 class="mb-3">Alert Thresholds</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="cpuAlertThreshold" class="form-label">CPU Alert Threshold (%)</label>
                                                <input type="number" class="form-control" id="cpuAlertThreshold" 
                                                       name="cpuAlertThreshold" value="80" min="50" max="95">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="memoryAlertThreshold" class="form-label">Memory Alert Threshold (%)</label>
                                                <input type="number" class="form-control" id="memoryAlertThreshold" 
                                                       name="memoryAlertThreshold" value="85" min="60" max="95">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="diskAlertThreshold" class="form-label">Disk Alert Threshold (%)</label>
                                                <input type="number" class="form-control" id="diskAlertThreshold" 
                                                       name="diskAlertThreshold" value="90" min="70" max="98">
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance -->
                    <div class="tab-pane fade" id="maintenance">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Maintenance Settings</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="mb-3">Backup Settings</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="backupFrequency" class="form-label">Backup Frequency</label>
                                            <select class="form-select" id="backupFrequency" name="backupFrequency">
                                                <option value="daily" selected>Daily</option>
                                                <option value="weekly">Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="backupRetention" class="form-label">Backup Retention (days)</label>
                                            <input type="number" class="form-control" id="backupRetention" 
                                                   name="backupRetention" value="30" min="7" max="365">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoBackup" 
                                               name="autoBackup" checked>
                                        <label class="form-check-label" for="autoBackup">
                                            Enable Automatic Backups
                                        </label>
                                    </div>
                                </div>

                                <hr>

                                <h6 class="mb-3">Log Management</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="logRetention" class="form-label">Log Retention (days)</label>
                                            <input type="number" class="form-control" id="logRetention" 
                                                   name="logRetention" value="90" min="30" max="365">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="logLevel" class="form-label">Log Level</label>
                                            <select class="form-select" id="logLevel" name="logLevel">
                                                <option value="ERROR">Error</option>
                                                <option value="WARN">Warning</option>
                                                <option value="INFO" selected>Info</option>
                                                <option value="DEBUG">Debug</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-warning me-2" onclick="cleanupLogs()">
                                        <i class="ri-delete-bin-line me-1"></i>Cleanup Old Logs
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="createBackup()">
                                        <i class="ri-database-2-line me-1"></i>Create Manual Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize settings functionality
            initializeSettings();
        });

        function initializeSettings() {
            // Load current settings
            loadCurrentSettings();
            
            // Setup tab navigation
            setupTabNavigation();
        }

        function loadCurrentSettings() {
            // In a real application, this would load settings from the server
            console.log('Loading current settings...');
        }

        function setupTabNavigation() {
            const tabLinks = document.querySelectorAll('[data-bs-toggle="pill"]');
            tabLinks.forEach(link => {
                link.addEventListener('shown.bs.tab', function(e) {
                    // Update active state
                    tabLinks.forEach(l => l.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });
        }

        function saveAllSettings() {
            // Collect all form data
            const forms = ['generalSettingsForm', 'emailSettingsForm', 'securitySettingsForm', 
                          'notificationSettingsForm'];
            
            const allSettings = {};
            
            forms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    const formData = new FormData(form);
                    for (let [key, value] of formData.entries()) {
                        allSettings[key] = value;
                    }
                }
            });

            // Add checkbox values
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                allSettings[checkbox.name] = checkbox.checked;
            });

            // Save settings
            fetch('/admin/settings/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(allSettings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Settings saved successfully!', 'success');
                } else {
                    showAlert('Error saving settings: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while saving settings.', 'danger');
            });
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                fetch('/admin/settings/reset', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        showAlert('Error resetting settings: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred while resetting settings.', 'danger');
                });
            }
        }

        function testEmailConnection() {
            const smtpData = {
                host: document.getElementById('smtpHost').value,
                port: document.getElementById('smtpPort').value,
                username: document.getElementById('smtpUsername').value,
                password: document.getElementById('smtpPassword').value,
                enableTLS: document.getElementById('enableTLS').checked
            };

            fetch('/admin/settings/test-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(smtpData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Email connection test successful!', 'success');
                } else {
                    showAlert('Email connection test failed: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while testing email connection.', 'danger');
            });
        }

        function cleanupLogs() {
            if (confirm('Are you sure you want to cleanup old log files?')) {
                fetch('/admin/settings/cleanup-logs', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Log cleanup completed successfully!', 'success');
                    } else {
                        showAlert('Error during log cleanup: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred during log cleanup.', 'danger');
                });
            }
        }

        function createBackup() {
            fetch('/admin/settings/create-backup', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Backup created successfully!', 'success');
                } else {
                    showAlert('Error creating backup: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while creating backup.', 'danger');
            });
        }

        function showAlert(message, type) {
            // Create and show bootstrap alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
