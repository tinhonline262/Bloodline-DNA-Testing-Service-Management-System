<!DOCTYPE html>
<html th:replace="~{layouts/admin-layout :: layout(~{::#content}, ~{::script}, 'User Management', ~{::breadcrumbs}, ~{::actionButtons})}"
    xmlns:th="http://www.thymeleaf.org" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light"
    data-menu-styles="light" loader="disable" data-vertical-style="overlay" class="mdl-js"
    data-toggled="icon-overlay-close">

<body>
    <!-- Breadcrumbs -->
    <div id="breadcrumbs">
        <li class="breadcrumb-item"><a th:href="@{/admin/users}">User Management</a></li>
    </div>

    <!-- Action Buttons -->
    <div id="actionButtons">
        <button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="ri-user-add-line me-1"></i>Add New User
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="ri-download-line me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" th:href="@{/admin/users/export/excel}">Export as Excel</a></li>
                <li><a class="dropdown-item" th:href="@{/admin/users/export/pdf}">Export as PDF</a></li>
                <li><a class="dropdown-item" th:href="@{/admin/users/export/csv}">Export as CSV</a></li>
            </ul>
        </div>
    </div>

    <div id="content">
        <!-- User Statistics -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="ri-admin-line fs-30 me-3"></i>
                            <div>
                                <h5 class="mb-0" th:text="${userStats.totalAdmins ?: 0}">0</h5>
                                <p class="mb-0">Administrators</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="ri-user-star-line fs-30 me-3"></i>
                            <div>
                                <h5 class="mb-0" th:text="${userStats.totalManagers ?: 0}">0</h5>
                                <p class="mb-0">Managers</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="ri-user-line fs-30 me-3"></i>
                            <div>
                                <h5 class="mb-0" th:text="${userStats.totalCustomers ?: 0}">0</h5>
                                <p class="mb-0">Customers</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="ri-user-add-line fs-30 me-3"></i>
                            <div>
                                <h5 class="mb-0" th:text="${userStats.newUsersThisMonth ?: 0}">0</h5>
                                <p class="mb-0">New This Month</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Users</h5>
                <div class="d-flex gap-2">
                    <!-- Filter Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ri-filter-line me-1"></i>Filter by Role
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?role=all">All Users</a></li>
                            <li><a class="dropdown-item" href="?role=ADMIN">Administrators</a></li>
                            <li><a class="dropdown-item" href="?role=MANAGER">Managers</a></li>
                            <li><a class="dropdown-item" href="?role=CUSTOMER">Customers</a></li>
                        </ul>
                    </div>
                    
                    <!-- Search Input -->
                    <div class="input-group" style="width: 250px;">
                        <input type="text" class="form-control" placeholder="Search users..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="ri-search-line"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}">
                                <td>
                                    <input type="checkbox" class="form-check-input user-checkbox" th:value="${user.id}">
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img th:if="${user.profileImageUrl}" th:src="@{${user.profileImageUrl}}" 
                                             class="avatar avatar-sm rounded-circle me-2" alt="Profile">
                                        <img th:unless="${user.profileImageUrl}" src="/assets/images/faces/default-avatar.png" 
                                             class="avatar avatar-sm rounded-circle me-2" alt="Default Avatar">
                                        <div>
                                            <h6 class="mb-0" th:text="${user.firstName + ' ' + user.lastName}">John Doe</h6>
                                            <small class="text-muted" th:text="${user.username}">johndoe</small>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${user.email}">john@example.com</td>
                                <td>
                                    <span th:class="'badge bg-' + ${user.role == 'ADMIN' ? 'danger' : user.role == 'MANAGER' ? 'success' : 'info'}"
                                          th:text="${user.role}">CUSTOMER</span>
                                </td>
                                <td>
                                    <span th:class="'badge bg-' + ${user.active ? 'success' : 'secondary'}"
                                          th:text="${user.active ? 'Active' : 'Inactive'}">Active</span>
                                </td>
                                <td>
                                    <span th:if="${user.lastLoginDate}" 
                                          th:text="${#temporals.format(user.lastLoginDate, 'dd/MM/yyyy HH:mm')}">04/07/2025 10:30</span>
                                    <span th:unless="${user.lastLoginDate}" class="text-muted">Never</span>
                                </td>
                                <td th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy')}">04/07/2025</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                th:onclick="'viewUser(' + ${user.id} + ')'" title="View Details">
                                            <i class="ri-eye-line"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                th:onclick="'editUser(' + ${user.id} + ')'" title="Edit User">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                th:onclick="'toggleUserStatus(' + ${user.id} + ')'" 
                                                th:title="${user.active ? 'Deactivate' : 'Activate'}">
                                            <i th:class="${user.active ? 'ri-lock-line' : 'ri-lock-unlock-line'}"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                th:onclick="'deleteUser(' + ${user.id} + ')'" title="Delete User">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(users)}">
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="ri-user-line fs-30 mb-2"></i>
                                    <p>No users found.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav th:if="${totalPages > 1}" aria-label="User pagination">
                    <ul class="pagination justify-content-center">
                        <li th:class="${currentPage == 0} ? 'page-item disabled' : 'page-item'">
                            <a class="page-link" th:href="@{/admin/users(page=${currentPage - 1}, size=${size})}">Previous</a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}" 
                            th:class="${i == currentPage} ? 'page-item active' : 'page-item'">
                            <a class="page-link" th:href="@{/admin/users(page=${i}, size=${size})}" th:text="${i + 1}">1</a>
                        </li>
                        <li th:class="${currentPage == totalPages - 1} ? 'page-item disabled' : 'page-item'">
                            <a class="page-link" th:href="@{/admin/users(page=${currentPage + 1}, size=${size})}">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Bulk Actions Panel -->
        <div class="card mt-3" id="bulkActionsPanel" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="selectedCount">0 users selected</span>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary" onclick="bulkActivate()">
                            <i class="ri-check-line me-1"></i>Activate Selected
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="bulkDeactivate()">
                            <i class="ri-close-line me-1"></i>Deactivate Selected
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="bulkDelete()">
                            <i class="ri-delete-bin-line me-1"></i>Delete Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/admin/users}" method="post" id="addUserForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">Role *</label>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="">Select Role</option>
                                        <option value="ADMIN">Administrator</option>
                                        <option value="MANAGER">Manager</option>
                                        <option value="CUSTOMER">Customer</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                            <div class="form-text">Password must be at least 8 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="active" name="active" checked>
                                <label class="form-check-label" for="active">
                                    Active User
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize user management functionality
            initializeUserManagement();
        });

        function initializeUserManagement() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterUsers(this.value);
                });
            }

            // Select all functionality
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const userCheckboxes = document.querySelectorAll('.user-checkbox');
                    userCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateBulkActionsPanel();
                });
            }

            // Individual checkbox handlers
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            userCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateBulkActionsPanel();
                });
            });
        }

        function filterUsers(searchTerm) {
            const table = document.getElementById('usersTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let row of rows) {
                const userCell = row.cells[1];
                const emailCell = row.cells[2];
                
                if (userCell && emailCell) {
                    const userName = userCell.textContent.toLowerCase();
                    const userEmail = emailCell.textContent.toLowerCase();
                    const searchLower = searchTerm.toLowerCase();
                    
                    if (userName.includes(searchLower) || userEmail.includes(searchLower)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        }

        function updateBulkActionsPanel() {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            const panel = document.getElementById('bulkActionsPanel');
            const countSpan = document.getElementById('selectedCount');
            
            if (checkedBoxes.length > 0) {
                panel.style.display = 'block';
                countSpan.textContent = checkedBoxes.length + ' user' + (checkedBoxes.length === 1 ? '' : 's') + ' selected';
            } else {
                panel.style.display = 'none';
            }
        }

        function viewUser(userId) {
            // Implementation for viewing user details
            window.location.href = '/admin/users/' + userId;
        }

        function editUser(userId) {
            // Implementation for editing user
            window.location.href = '/admin/users/' + userId + '/edit';
        }

        function toggleUserStatus(userId) {
            if (confirm('Are you sure you want to toggle this user\'s status?')) {
                fetch('/admin/users/' + userId + '/toggle-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating user status.');
                });
            }
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                fetch('/admin/users/' + userId, {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting user.');
                });
            }
        }

        function bulkActivate() {
            performBulkAction('activate', 'activate');
        }

        function bulkDeactivate() {
            performBulkAction('deactivate', 'deactivate');
        }

        function bulkDelete() {
            performBulkAction('delete', 'delete');
        }

        function performBulkAction(action, actionName) {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            const userIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (userIds.length === 0) {
                alert('Please select users first.');
                return;
            }
            
            if (confirm(`Are you sure you want to ${actionName} ${userIds.length} user(s)?`)) {
                fetch('/admin/users/bulk-' + action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ userIds: userIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while performing bulk action.');
                });
            }
        }
    </script>
</body>
</html>
